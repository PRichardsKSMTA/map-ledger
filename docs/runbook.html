<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>MapLedger Runbook â€” Master Copy (UpdatedÂ 23â€¯Junâ€¯2025)</title>
<style>
body{font-family:system-ui,sans-serif;line-height:1.5;margin:0 2rem 4rem;color:#1a1a1a}
h1,h2,h3,h4{color:#104e8b;margin-top:2.2rem}
h1{font-size:2rem;border-bottom:4px solid #104e8b;padding-bottom:.3rem;margin-top:1.5rem}
h2{font-size:1.4rem;border-left:6px solid #104e8b;padding-left:.6rem}
table{border-collapse:collapse;width:100%;margin:1rem 0;font-size:.9rem}
th,td{border:1px solid #dadada;padding:.4rem .6rem;vertical-align:top}
tr:nth-child(even){background:#f8f8f8}
code,pre{background:#f3f3f3;border:1px solid #e2e2e2;border-radius:4px;padding:.1rem .3rem;font-size:.85rem}
.example-block{border:2px dashed #777;padding:1rem;margin:1.2rem 0;background:#fafafa}
.toc a{color:#104e8b;text-decoration:none}
</style>
<style>
#side-nav{position:fixed;left:0;top:0;height:100%;width:220px;background:#f2f6fa;border-right:1px solid #d0d7de;padding:1rem;overflow-y:auto}
#side-nav a{display:block;color:#104e8b;text-decoration:none;margin:.4rem 0;font-size:.9rem}
#content{margin-left:240px}
@media(max-width:900px){#side-nav{display:none}#content{margin-left:0}}
</style>
</head>
<body>
<div id="side-nav"><h3>Runbook</h3><a href="#vision">1Â Â·Â VisionÂ &amp;Â Objectives</a><a href="#terminology">2Â Â·Â CoreÂ Terminology</a><a href="#architecture">3Â Â·Â System Architecture</a><a href="#ingestion">4Â Â·Â Dataâ€‘Ingestion Pipeline</a><a href="#scoa">5Â Â·Â StandardÂ ChartÂ ofÂ Accounts (Sâ€‘COA)</a><a href="#workflow">&gt;6Â Â·Â ConsolidateÂ â†’Â MapÂ â†’Â AllocateÂ Workflow</a><a href="#examples">7Â Â·Â VisualÂ Examples (from Trialâ€‘Balance workbook)</a><a href="#distribution">
&gt;8Â Â·Â DistributionÂ MethodsÂ &amp;Â Metrics</a><a href="#frontend">9Â Â·Â Frontâ€‘EndÂ UX Flow</a><a href="#permissions">10Â Â·Â RolesÂ &amp;Â Permissions</a><a href="#nfr">11Â Â·Â Nonâ€‘FunctionalÂ Requirements</a><a href="#release">12Â Â·Â ReleaseÂ Timeline</a><a href="#codex">13Â Â·Â CodexÂ WorkflowÂ &amp;Â RepoÂ Docs</a></div><div id="content">
<h1>MapLedgerÂ RunbookÂ â€”Â MasterÂ Copy <small>(updatedÂ 23Â JunÂ 2025)</small></h1>
<p><em>This selfâ€‘contained HTML replaces all previous Markdown runbooks. Commit as <code>docs/runbook.html</code>.</em></p>
<section class="toc">
<h2>TableÂ ofÂ Contents</h2>
<ol>
<li><a href="#vision">VisionÂ &amp;Â Objectives</a></li>
<li><a href="#terminology">Core Terminology</a></li>
<li><a href="#architecture">System Architecture</a></li>
<li><a href="#ingestion">Dataâ€‘Ingestion Pipeline</a></li>
<li><a href="#scoa">Standard Chart of Accounts</a></li>
<li><a href="#workflow">Consolidate â†’ Map â†’ Allocate</a></li>
<li><a href="#examples">Visual Examples</a></li>
<li><a href="#distribution">Distribution Methods &amp;Â Metrics</a></li>
<li><a href="#frontend">Frontâ€‘End UX Flow</a></li>
<li><a href="#permissions">Roles &amp;Â Permissions</a></li>
<li><a href="#nfr">Nonâ€‘Functional Requirements</a></li>
<li><a href="#release">Release Timeline</a></li>
<li><a href="#codex">Codex Guidance &amp;Â Repo Docs</a></li>
</ol>
</section>
<hr/>
<h2 id="vision">1Â Â·Â VisionÂ &amp;Â Objectives</h2>
<ul>
<li><strong>Oneâ€‘click ingestion</strong> of any client Trial Balance (CSV/XLSX) regardless of layout.</li>
<li><strong>AIâ€‘assisted mapping</strong> to a single Standard COA (Sâ€‘COA) with confidence scoring.</li>
<li><strong>Multiâ€‘entity consolidation</strong> across periods, ledgers, operations.</li>
<li><strong>Ruleâ€‘driven allocation</strong> of consolidated balances to operations (direct or metric ratios).</li>
<li><strong>Governed access</strong> through Azure AD roles from organisationÂ â†’ clientÂ â†’ operation.</li>
<li><strong>MVP goâ€‘live</strong> target: <strong>16Â NovÂ 2025</strong>.</li>
</ul>
<h3>Screenshots (placeholders)</h3>
<p><img alt="Dashboard mock" src="screenshots/dashboard.png" style="width:100%;max-width:600px;border:1px solid #ccc"/></p>
<p><img alt="GL Upload" src="screenshots/upload.png" style="width:100%;max-width:600px;border:1px solid #ccc"/></p>
<p><img alt="Mapping UI" src="screenshots/mapping.png" style="width:100%;max-width:600px;border:1px solid #ccc"/></p>
<h2 id="terminology">2Â Â·Â CoreÂ Terminology</h2>
<table>
<thead><tr><th>Term</th><th>Meaning</th></tr></thead>
<tbody>
<tr><td><strong>Company</strong></td><td>Legal ledger supplying its own Trial Balance (e.g.Â VANÂ LLC).</td></tr>
<tr><td><strong>Operation</strong></td><td>Business line that receives allocated costs (Van, Flatbed,Â â€¦).</td></tr>
<tr><td><strong>Sâ€‘COA</strong></td><td>Canonical chart defined in Â§5.</td></tr>
<tr><td><strong>DistributionÂ Method</strong></td><td>Rule for splitting a value: <code>Direct</code>, <code>PctOfMiles</code>, <code>PctOf&lt;Metric&gt;</code>, <code>CustomRatio</code>.</td></tr>
<tr><td><strong>LayoutÂ Hash</strong></td><td>SHAâ€‘256 fingerprint of the firstÂ 20 rows; key for cached column maps.</td></tr>
<tr><td><strong>GLAccountRaw</strong></td><td>Staging table holding every cleaned TB line.</td></tr>
<tr><td><strong>GLUpload</strong></td><td>Upload session header (blob URL, status, user).</td></tr>
</tbody>
</table>
<h2 id="architecture">3Â Â·Â System Architecture</h2>
<pre>
React SPA â”€â”€â–º Azure Blob (SAS) â”€â”€â–º ProcessGLÂ (Function)
                        â–²                    â”‚   â†³ Redis (layout cache)
                        â”‚                    â–¼
                Browser â—„â”€â”€â”€â”€ REST JSON â—„â”€â”€ SuggestMappingsÂ (FunctionÂ +Â GPTâ€‘4)
                                                   â”‚
                                                   â–¼
                                           AzureÂ SQLÂ (stgÂ &amp;Â dbo)
</pre>
<p><em>For full endpoint lists, CLI snippets, and DDL, see <a href="runbook_detailed.html">RunbookÂ DetailedÂ Spec</a>.</em></p>
<p><strong>Numeric Storage Rule:</strong> persist raw decimals (no $ or commas). Formatting is applied only in the UI via <code>Intl.NumberFormat</code>.</p>
<p><em>Store numeric facts without <code>$</code> or commas; UI formats using <code>Intl.NumberFormat</code>.</em></p>
<h2 id="ingestion">4Â Â·Â Dataâ€‘Ingestion Pipeline</h2>
<ol>
<li><strong>Fingerprint</strong> sheet â†’ <code>layoutHash</code>.</li>
<li><strong>Detect layout</strong> â€“ reuse cache or invoke GPTâ€‘4 (fewâ€‘shot with sample sheets).</li>
<li><strong>Parse &amp; normalise</strong> â€“ drop metadata/subtotals, merge multiâ€‘row headers, melt wide months, strip symbols.</li>
<li><strong>Deduplicate</strong> on entity + account + period.</li>
<li><strong>Insert</strong> into <code>stg.GLAccountRaw</code>; <code>MERGE</code> into <code>dbo.GLAccountFact</code>.</li>
<li><strong>Totals view</strong> rebuilds group/subtotal lines for reports.</li>
</ol>
<h2 id="scoa">5Â Â·Â StandardÂ ChartÂ ofÂ Accounts (Sâ€‘COA)</h2>
<p>The FreightMath Standard Chart of Accounts (Sâ€‘COA) currently contains <strong>80</strong> GL accounts. Each line supplies a <code>GL_ID</code>, <code>GL_NAME</code>, and <code>DETAIL_LEVEL</code> (1Â = leaf / 2Â = rollâ€‘up).</p>
<h3>5.1Â JSONÂ Export</h3>
<p>The full COA is generated from the spreadsheet by <code>scripts/build_coa_json.ts</code>. Below is an excerpt; Codex should reference the JSON rather than hardâ€‘coding IDs.</p>
<pre>{
  "templateId": "default-freight-v1",
  "accountCount": 80,
  "accountsSample": [
    {
      "glId": "2990",
      "glName": "OPERATING RATIO - TOTAL ASSET OPERATIONS",
      "detailLevel": 1
    },
    {
      "glId": "2",
      "glName": "FREIGHT REVENUE LINEHAUL - COMPANY FLEET",
      "detailLevel": 1
    },
    {
      "glId": "3",
      "glName": "FREIGHT REVENUE LINEHAUL - OWNER OPERATOR",
      "detailLevel": 1
    },
    {
      "glId": "296",
      "glName": "FREIGHT REVENUE LINEHAUL - LEASE PURCHASE",
      "detailLevel": 1
    },
    {
      "glId": "102",
      "glName": "FREIGHT REVENUE LINEHAUL - BROKERAGE",
      "detailLevel": 1
    },
    {
      "glId": "4",
      "glName": "ACCESSORIAL REVENUE - COMPANY FLEET",
      "detailLevel": 1
    },
    {
      "glId": "5",
      "glName": "ACCESSORIAL REVENUE - OWNER OPERATOR",
      "detailLevel": 1
    },
    {
      "glId": "299",
      "glName": "ACCESSORIAL REVENUE - LEASE PURCHASE",
      "detailLevel": 1
    },
    {
      "glId": "105",
      "glName": "ACCESSORIAL REVENUE - BROKERAGE",
      "detailLevel": 1
    },
    {
      "glId": "6",
      "glName": "FUEL SURCHARGE REVENUE - COMPANY FLEET",
      "detailLevel": 1
    }
  ]
}</pre>
<h3>5.2Â Preview (firstÂ 15 rows)</h3>
<table class="dataframe coa-preview">
<thead>
<tr style="text-align: right;">
<th>GL_ID</th>
<th>GL_NAME</th>
<th>DETAIL_LEVEL</th>
</tr>
</thead>
<tbody>
<tr>
<td>2990</td>
<td>OPERATING RATIO - TOTAL ASSET OPERATIONS</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>FREIGHT REVENUE LINEHAUL - COMPANY FLEET</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>FREIGHT REVENUE LINEHAUL - OWNER OPERATOR</td>
<td>1</td>
</tr>
<tr>
<td>296</td>
<td>FREIGHT REVENUE LINEHAUL - LEASE PURCHASE</td>
<td>1</td>
</tr>
<tr>
<td>102</td>
<td>FREIGHT REVENUE LINEHAUL - BROKERAGE</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>ACCESSORIAL REVENUE - COMPANY FLEET</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>ACCESSORIAL REVENUE - OWNER OPERATOR</td>
<td>1</td>
</tr>
<tr>
<td>299</td>
<td>ACCESSORIAL REVENUE - LEASE PURCHASE</td>
<td>1</td>
</tr>
<tr>
<td>105</td>
<td>ACCESSORIAL REVENUE - BROKERAGE</td>
<td>1</td>
</tr>
<tr>
<td>6</td>
<td>FUEL SURCHARGE REVENUE - COMPANY FLEET</td>
<td>1</td>
</tr>
<tr>
<td>7</td>
<td>FUEL SURCHARGE REVENUE - OWNER OPERATOR</td>
<td>1</td>
</tr>
<tr>
<td>302</td>
<td>FUEL SURCHARGE REVENUE - LEASE PURCHASE</td>
<td>1</td>
</tr>
<tr>
<td>108</td>
<td>FUEL SURCHARGE REVENUE - BROKERAGE</td>
<td>1</td>
</tr>
<tr>
<td>8</td>
<td>DRIVER WAGES - COMPANY FLEET</td>
<td>1</td>
</tr>
<tr>
<td>89</td>
<td>DRIVER BENEFITS, PAYROLL TAXES AND BONUS COMPENSATION - COMPANY FLEET</td>
<td>1</td>
</tr>
</tbody>
</table>
<h3>5.3Â UpdateÂ Script</h3>
<ol><li>Run <code>npm run build:coa</code> to refresh <code>data/fm_coa.json</code> whenever the Excel changes.</li><li>CI checks will fail if the JSON is out of sync.</li></ol>
<h2 id="workflow">&gt;6Â Â·Â ConsolidateÂ â†’Â MapÂ â†’Â AllocateÂ Workflow</h2>
<ol>
<li>Upload each entityâ€™s TB.</li>
<li>System creates <strong>Consolidated</strong> totals per period.</li>
<li>AI suggests Sâ€‘COA mapping; user approves/overrides.</li>
<li>Wizard allocates each mapped total to operations:<br/>
   â€¢ <code>DirectCompany</code> autoâ€‘links entity rows.<br/>
   â€¢ <code>DirectConsolidated</code> manual % on the total.<br/>
   â€¢ Ratio methods pull reference metrics (miles, headcountâ€¦).</li>
<li>Commit writes <code>dbo.OpGLFact</code> (operationâ€‘level facts).</li>
</ol>
<h2 id="examples">7Â Â·Â VisualÂ Examples (from Trialâ€‘Balance workbook)</h2>
<h3>7.1Â ConsolidationÂ (Entities âœ Consolidated)</h3>
<div class="example-block">
<table>
<thead><tr><th>RowÂ Type</th><th>ConcatÂ ID</th><th>Description</th><th>USD</th></tr></thead>
<tbody>
<tr><td><strong>Consolidated</strong></td><td>10100</td><td>AccountsÂ Receivable</td><td>501â€¯000</td></tr>
<tr><td>CompanyÂ Row</td><td>VANâ€‘10100</td><td>AccountsÂ ReceivableÂ â€“Â VAN</td><td>500â€¯000</td></tr>
<tr><td>CompanyÂ Row</td><td>METAâ€‘10100</td><td>AccountsÂ ReceivableÂ â€“Â META</td><td>Â Â 1â€¯000</td></tr>
<tr><td><strong>Consolidated</strong></td><td>11000</td><td>PrepaidÂ Expense</td><td>Â Â Â Â 9â€¯500</td></tr>
<tr><td>CompanyÂ Row</td><td>VANâ€‘11000</td><td>PrepaidÂ ExpenseÂ â€“Â VAN</td><td>Â Â Â Â 9â€¯000</td></tr>
<tr><td>CompanyÂ Row</td><td>METAâ€‘11000</td><td>PrepaidÂ ExpenseÂ â€“Â META</td><td>Â Â Â Â Â Â 500</td></tr>
</tbody></table>
</div>
<h3>7.2Â MappingÂ (Consolidated âœ Sâ€‘COA)</h3>
<div class="example-block">
<table>
<thead><tr><th>ConsolidatedÂ ID</th><th>SuggestedÂ Sâ€‘COAÂ GL_ID</th><th>Name</th><th>Confidence</th><th>Status</th></tr></thead>
<tbody>
<tr><td>10100</td><td>10100</td><td>AccountsÂ Receivable</td><td>95Â %</td><td>âœ” Accepted</td></tr>
<tr><td>21107â€‘800Â (CreditÂ Card)</td><td>70000</td><td>CreditÂ CardÂ Fees</td><td>78Â %</td><td>âš  Review</td></tr>
<tr><td>23150Â (TollsÂ /Â Scales)</td><td>53300Â â†’Â Tolls<br/>53400Â â†’Â Scales</td><td>Split Mapping</td><td>80Â %</td><td>ğŸ› Â UserÂ split</td></tr>
</tbody></table>
</div>
<h3>7.3Â AllocationÂ (MappedÂ Total âœ Operations)</h3>
<div class="example-block">
<table>
<thead><tr><th>Sâ€‘COAÂ GL_ID</th><th>Operation</th><th>Method</th><th>%Â ofÂ Source</th><th>AllocatedÂ USD</th></tr></thead>
<tbody>
<tr><td>10100</td><td>VAN</td><td>DirectCompany</td><td>100â€¯%</td><td>500â€¯000</td></tr>
<tr><td>10100</td><td>LOG</td><td>DirectCompany</td><td>100â€¯%</td><td>Â Â 1â€¯000</td></tr>
<tr><td>11000</td><td>VAN</td><td>DirectConsolidated</td><td>50â€¯%</td><td>4â€¯750</td></tr>
<tr><td>11000</td><td>LOG</td><td>DirectConsolidated</td><td>50â€¯%</td><td>4â€¯750</td></tr>
<tr><td>21107â€‘800</td><td>VAN</td><td>PctOfMiles</td><td>90â€¯%</td><td>2â€¯700</td></tr>
<tr><td>21107â€‘800</td><td>LOG</td><td>PctOfMiles</td><td>10â€¯%</td><td>Â Â Â 300</td></tr>
<tr><td>53300Â (Tolls)</td><td>VAN</td><td>CustomRatio</td><td>80â€¯%</td><td>16â€¯000</td></tr>
<tr><td>53400Â (Scales)</td><td>VAN</td><td>CustomRatio</td><td>20â€¯%</td><td>Â 4â€¯000</td></tr>
</tbody></table>
<p style="font-size:.85rem"><em>The CustomRatio rows inherit a secondâ€‘level split once the 80â€¯% Tolls total is itself distributed across VANÂ vsÂ LOG if required.</em></p>
</div>
<h3>7.4Â OperationalÂ Metrics EntryÂ &amp;Â History</h3>
<div class="example-block">
<table>
<thead><tr><th>Metric</th><th>CurrentÂ Value</th><th>LastÂ Updated</th><th>Status</th></tr></thead>
<tbody>
<tr><td>OfficeÂ Headcount</td><td>42</td><td>2025â€‘05â€‘31</td><td>âœ… UpÂ toÂ date</td></tr>
<tr><td>MaintenanceÂ Headcount</td><td>7</td><td>2025â€‘03â€‘31</td><td style="color:red">âš Â 2Â months overdue</td></tr>
<tr><td>MilesÂ Driven</td><td>2â€¯145â€¯000</td><td>2025â€‘05â€‘31</td><td>âœ…</td></tr>
</tbody></table>
</div>
<p>Admins update these per period on <code>/client/:id/metrics</code>. Ratio distribution methods (e.g. <code>PctOfMiles</code>) pull the values automatically.</p>
<h2 id="distribution">
&gt;8Â Â·Â DistributionÂ MethodsÂ &amp;Â Metrics</h2>
<table>
<thead><tr><th>Method</th><th>Metric Source</th><th>Auto</th><th>Notes</th></tr></thead>
<tbody>
<tr><td><strong>DirectCompany</strong></td><td>CompanyÂ value</td><td>Yes</td><td>1â€‘toâ€‘1.</td></tr>
<tr><td><strong>DirectConsolidated</strong></td><td>TotalÂ value</td><td>User</td><td>Manual % split.</td></tr>
<tr><td><strong>PctOfMiles</strong></td><td>Metrics.Miles</td><td>Yes</td><td>Period miles per op.</td></tr>
<tr><td><strong>PctOf&lt;Metric&gt;</strong></td><td>Any metric</td><td>Yes</td><td>Headcount, tractors â€¦</td></tr>
<tr><td><strong>CustomRatio</strong></td><td>User input</td><td>Manual</td><td>Multiâ€‘GL splits.</td></tr>
</tbody>
</table>
<h2 id="frontend">9Â Â·Â Frontâ€‘EndÂ UX Flow</h2>
<ol>
<li><strong>ImportForm</strong> â€“ upload file, choose entities/ops.</li>
<li><strong>PreviewTable</strong> â€“ inspect parsed sheets, dedup duplicates.</li>
<li><strong>MappingÂ &amp;Â AllocationÂ Wizard</strong><br/>
   StepÂ 1Â MappingTable â†’ StepÂ 2Â RatioAllocationManager.</li>
<li><strong>ReviewÂ &amp;Â Commit</strong>.</li>
<li><strong>Dashboards</strong> â€“ Consolidated &amp; Op P&amp;L.</li>
</ol>
<h2 id="permissions">10Â Â·Â RolesÂ &amp;Â Permissions</h2>
<pre>
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Organisation  â”‚ (OrgAdmin)
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      Client       â”‚ (ClientAdmin)
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â”‚         â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”   â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Company   â”‚   â”‚ Operation â”‚ (OpUser)
   â”‚ (no role) â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
<table>
<thead><tr><th>Scope</th><th>Role</th><th>Access</th></tr></thead>
<tbody>
<tr><td>System</td><td>SysAdmin</td><td>All organisations</td></tr>
<tr><td>Organisation</td><td>OrgAdmin</td><td>All clients inside org</td></tr>
<tr><td>Client</td><td>ClientAdmin</td><td>All entities &amp; ops</td></tr>
<tr><td>Operation</td><td>OpUser</td><td>Single operation</td></tr>
</tbody>
</table>
<h2 id="nfr">11Â Â·Â Nonâ€‘FunctionalÂ Requirements</h2>
<ul>
<li>Ingest 50Â Ã—Â 10â€¯kâ€‘row workbooks in underÂ 2Â minutes cumulative.</li>
<li>Rowâ€‘level security, audit trail of every mapping/allocation change.</li>
<li>AppÂ Insights telemetry + OpenAI usage logging.</li>
<li>GitHub Actions CI/CD; staging autodeploy onÂ <code>main</code>.</li>
</ul>
<h2 id="release">12Â Â·Â ReleaseÂ Timeline</h2>
<table>
<thead>
<tr>
<th>Week</th>
<th>Dates</th>
<th>Key Tasks</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Jun 2 â€“ Jun 8, 2025</td>
<td>
<ul class="task-list">
<li><strong>Kickoff &amp; Requirements Gathering:</strong>
<ul class="subtask-list">
<li>Schedule and conduct project kickoff meeting (all stakeholders present).</li>
<li>Document detailed functional requirements:
                      <ul class="subtask-list">
<li>Client hierarchy specifications (Master vs. Operations).</li>
<li>COA template fields and expected JSON format.</li>
<li>AI mapping acceptance thresholds.</li>
<li>Reporting KPIs and benchmarking logic.</li>
</ul>
</li>
<li>Define initial use cases and user stories:
                      <ul class="subtask-list">
<li>â€œAs an Admin User, I want to upload a GL CSV so that I can map accounts.â€</li>
<li>â€œAs a Super User, I want to create a new industry and upload its COA.â€</li>
</ul>
</li>
<li>Set up project repository structure (GitHub):
                      <ul class="subtask-list">
<li>Create monorepo with two folders: <code>/frontend</code> and <code>/backend</code>.</li>
<li>Initialize ESLint, Prettier, Husky, and CI skeleton pipelines.</li>
</ul>
</li>
</ul>
</li>
</ul>
</td>
</tr>
<tr>
<td>2â€“3</td>
<td>Jun 9 â€“ Jun 22, 2025</td>
<td>
<ul class="task-list">
<li><strong>Architecture &amp; Data Modeling:</strong>
<ul class="subtask-list">
<li>Design high-level architecture diagram:
                      <ul class="subtask-list">
<li>Frontend SPA (React + TypeScript) â†’ Backend Azure Functions (TypeScript) â†’ Database Azure SQL â†’ Azure Blob Storage â†’ Azure AD â†’ OpenAI API â†’ Azure Synapse Analytics.</li>
</ul>
</li>
<li>Define data model ER diagram:
                      <ul class="subtask-list">
<li>Entities: Industry, COATemplate, COAAccount, MasterClient, ClientOperation, GLUpload, GLAccountRaw, MappingSuggestion, FinalMapping, AuditLog, User.</li>
<li>Relationships, cardinalities, and cascades.</li>
</ul>
</li>
<li>Draft OpenAPI (Swagger) spec for all endpoints:
                      <ul class="subtask-list">
<li>Organize by resource: <code>/api/industries</code>, <code>/api/masterclients</code>, <code>/api/operations</code>, <code>/api/coa</code>, <code>/api/gl</code>, <code>/api/mapping</code>, <code>/api/report</code>.</li>
<li>Define request/response schemas using JSON Schema ($ref to entity definitions).</li>
</ul>
</li>
<li>Set up Azure Resource Group (RG) naming conventions and folder structure in Terraform or ARM templates (if using IaC this early).</li>
</ul>
</li>
</ul>
</td>
</tr>
<tr>
<td>3â€“4</td>
<td>Jun 23 â€“ Jul 6, 2025</td>
<td>
<ul class="task-list">
<li><strong>Database &amp; Infrastructure Provisioning:</strong>
<ul class="subtask-list">
<li>Provision Azure SQL Server &amp; Database (<code>mapledger-sql-server</code>, <code>mapledger-db</code>):
                      <ul class="subtask-list">
<li>Enable TDE and Geo-Replication to secondary region.</li>
<li>Configure Azure AD Admin for SQL server.</li>
</ul>
</li>
<li>Execute initial SQL migrations:
                      <ul class="subtask-list">
<li>Create tables: <code>Industry, MasterClient, ClientOperation, COATemplate, COAAccount, GLUpload, GLAccountRaw, MappingSuggestion, FinalMapping, AuditLog, [User Tableâ€”if needed]</code>.</li>
<li>Seed data: initial industries (Retail, Manufacturing, Services).</li>
</ul>
</li>
<li>Provision Azure Blob Storage (<code>mapledgerstorage</code>):
                      <ul class="subtask-list">
<li>Create container <code>gl-uploads</code> (private).</li>
<li>Set lifecycle rule to delete uploads after 90 days.</li>
</ul>
</li>
<li>Provision Azure Cache for Redis (for mapping caching) if decision made.</li>
<li>Provision Azure Synapse Analytics workspace or dedicate reporting DB if chosen.</li>
</ul>
</li>
<li><strong>Backend Project Setup (Azure Functions):</strong>
<ul class="subtask-list">
<li>Initialize Node.js + TypeScript Function project (<code>func init mapledger-backend --typescript</code>).</li>
<li>Create folder structure:
                      <ul class="subtask-list">
<li><code>/src/functions</code> (each function in its own folder).</li>
<li><code>/src/entities</code> for TypeORM entities.</li>
<li><code>/src/repositories</code> for DB access.</li>
<li><code>/src/utils</code> (logging, common helpers).</li>
<li><code>/tests</code> for unit/integration tests.</li>
</ul>
</li>
<li>Configure <code>tsconfig.json</code> with <code>target: ES2020</code>, <code>module: commonjs</code>, and <code>strict</code> enabled.</li>
<li>Install dependencies:
                      <ul class="subtask-list">
<li><code>npm install azure-functions-core-tools @azure/storage-blob typeorm reflect-metadata mssql dotenv ajv</code></li>
<li>DevDependencies: <code>typescript ts-node jest @types/jest ts-jest eslint prettier</code></li>
</ul>
</li>
<li>Configure ESLint &amp; Prettier for consistent styling and run on commit via Husky pre-commit hook.</li>
</ul>
</li>
<li><strong>Front-End Project Setup (React + TypeScript):</strong>
<ul class="subtask-list">
<li>Initialize React project with Vite (<code>npm create vite@latest mapledger-frontend --template react-ts</code>).</li>
<li>Install dependencies:
                      <ul class="subtask-list">
<li><code>npm install react-router-dom@6 axios @azure/msal-browser @azure/msal-react tailwindcss@latest postcss autoprefixer</code></li>
<li>DevDependencies: <code>@testing-library/react jest @types/jest eslint-config-airbnb-typescript</code></li>
</ul>
</li>
<li>Configure TailwindCSS:
                      <ul class="subtask-list">
<li>Initialize Tailwind (<code>npx tailwindcss init -p</code>).</li>
<li>Edit <code>tailwind.config.js</code> to enable JIT mode and purge paths (<code>./src/**/*.{js,jsx,ts,tsx,html}</code>).</li>
<li>Import Tailwind directives in <code>index.css</code>:
                          <pre>
@tailwind base;
@tailwind components;
@tailwind utilities;
                          </pre>
</li>
</ul>
</li>
<li>Set up ESLint with Airbnb + TypeScript rules; configure import/order and React plugin rules.</li>
<li>Implement folder structure:
                      <ul class="subtask-list">
<li><code>/src/components</code> (UI components).</li>
<li><code>/src/pages</code> (routeable pages: Dashboard, Upload, Mapping, Admin).</li>
<li><code>/src/hooks</code> for custom React hooks (e.g., <code>useAuth</code>, <code>usePolling</code>).</li>
<li><code>/src/context</code> for global contexts (AuthContext, ThemeContext).</li>
<li><code>/src/services</code> for API calls (Axios instances, typed interfaces).</li>
<li><code>/src/utils</code> for shared utilities (formatters, validators).</li>
<li><code>/src/tests</code> for front-end Jest tests.</li>
</ul>
</li>
<li>Configure React Router v6 with routes:
                      <ul class="subtask-list">
<li><code>/login</code></li>
<li><code>/dashboard</code> (protected)</li>
<li><code>/gl/upload</code> (Admin)</li>
<li><code>/gl/mapping/{glUploadId}</code> (Admin)</li>
<li><code>/admin/industries</code> (SuperUser)</li>
<li><code>/admin/clients</code> (SuperUser)</li>
<li><code>/admin/users</code> (Admin &amp; SuperUser)</li>
<li><code>/reports</code> (Admin &amp; Viewer)</li>
</ul>
</li>
</ul>
</li>
</ul>
</td>
</tr><tr><td colspan="3" style="background:#fff2cc;text-align:center;">Company holiday â€“ no sprint work (JunÂ 28Â â€“Â JulÂ 6,Â 2025)</td></tr>
<tr>
  <td>5â€“6</td>
  <td>JulÂ 7â€¯â€“â€¯Julâ€¯20,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>AIÂ MappingÂ Engine (Backend):</strong>
        <ul class="subtask-list">
          <li>Create AzureÂ OpenAI resource; set <code>gptâ€‘4o</code> deployment &amp; fallback <code>gptâ€‘3.5â€‘turbo</code>.</li>
          <li>Design &amp; run promptâ€‘engineering matrix; document topâ€‘2 prompt formats in <code>docs/prompts/</code>.</li>
          <li>Implement <code>MappingSuggestion</code> DAL + migration (idempotent script).</li>
          <li>Rateâ€‘limit with DurableÂ Functions semaphore (throttleÂ â‰¤â€¯20â€¯rps per key).</li>
          <li>GDPR compliance review: purge PII from prompt payloads; add masking helper.</li>
        </ul>
      </li>
      <li><strong>COAÂ Template Builder (Frontâ€‘End):</strong>
        <ul class="subtask-list">
          <li>Treeâ€‘view MVP in Storybook; keyboard a11y (arrow keys, spaceÂ = toggle).</li>
          <li>Drag &amp; drop reorder; inline code/name validation (regex + duplicates).</li>
          <li>Autoâ€‘save debounce (2â€¯s) â†’ <code>PUT /api/coa/template/{id}</code>.</li>
          <li>Write unit tests with RTL +Â Jest; target â‰¥â€¯90â€¯% branch coverage for builder.</li>
        </ul>
      </li>
      <li><strong>Docs &amp; QA:</strong>
        <ul class="subtask-list">
          <li>Add <code>AIâ€‘MAPPING.md</code> with prompt structure + error codes.</li>
          <li>Codeâ€‘review checklist: latency budget (â‰¤â€¯3â€¯s /â€¯100 lines).</li>
        </ul>
      </li>
    </ul>
  </td>
</tr>

<tr>
  <td>7â€“8</td>
  <td>JulÂ 21â€¯â€“â€¯Augâ€¯3,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>GLÂ Upload Workflow:</strong>
        <ul class="subtask-list">
          <li>SASâ€‘URL endpoint emits 15â€‘min token; implement serverâ€‘clock skew guard.</li>
          <li>Dragâ€‘andâ€‘drop zone +Â multiâ€‘file batch upload (limitÂ 10).</li>
          <li>Excel parser: crossâ€‘sheet handling, hiddenâ€‘row skip, date serial fix.</li>
          <li>Invalidâ€‘column highlight (red header) + inline â€œmap columnâ€ dropdown.</li>
        </ul>
      </li>
      <li><strong>Blob Processing Function:</strong>
        <ul class="subtask-list">
          <li>Chunk insert 1â€¯000Â rows; resume on retry using <code>continuationToken</code>.</li>
          <li>Emit telemetry (<code>AppInsights</code>) â€“ bytes read, parseâ€¯ms, rows/s.</li>
          <li>Deadâ€‘letter queue for parsing failures; SendGrid alert to uploader.</li>
        </ul>
      </li>
      <li><strong>Testing &amp; Metrics:</strong>
        <ul class="subtask-list">
          <li>Cypress E2E: CSV happyâ€‘path + Excel edgeâ€‘case workbook.</li>
          <li>Define SLIs: â€œparseâ€‘rateâ€, â€œuploadâ€‘failâ€¯%â€; plot in Grafana dashboard.</li>
        </ul>
      </li>
    </ul>
  </td>
</tr>

<tr>
  <td>9â€“10</td>
  <td>AugÂ 4â€¯â€“â€¯Augâ€¯17,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>MappingÂ UX Enhancements:</strong>
        <ul class="subtask-list">
          <li>Virtualised grid (reactâ€‘window) â€“ target 50â€¯k rows @â€¯60â€¯fps scroll.</li>
          <li>Confidence colour scale via design tokens; WCAG contrast check.</li>
          <li>Keyboard bulkâ€‘actions: <kbd>Ctrlâ€¯+A</kbd> select highâ€‘confidence; <kbd>Delete</kbd>Â = clear overrides.</li>
          <li>Undo/redo stack (lastÂ 20 ops) stored in React context.</li>
        </ul>
      </li>
      <li><strong>Finalize &amp; Audit:</strong>
        <ul class="subtask-list">
          <li>Implement optimisticâ€‘UI save; rollback on 409Â (conflict).</li>
          <li>Write <code>auditLog()</code> wrapper; log every field diff JSON.</li>
          <li>Expose <code>/api/audit/{entity}/{id}</code> for internal auditors.</li>
        </ul>
      </li>
      <li><strong>Perf &amp; QA:</strong>
        <ul class="subtask-list">
          <li>Profile mapping render with React DevTools; memoise heavy cells.</li>
          <li>Crossâ€‘browser tests (Chrome, Edge, Firefox latestâ€‘2).</li>
        </ul>
      </li>
    </ul>
  </td>
</tr>

<tr>
  <td>11â€“12</td>
  <td>AugÂ 18â€¯â€“â€¯Augâ€¯31,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>AllocationÂ EngineÂ v1:</strong>
        <ul class="subtask-list">
          <li>Create <code>dbo.OperationMetric</code> &amp; <code>dbo.AllocationRule</code> tables.</li>
          <li>Ingest metrics CSV â†’Â Function timer nightly.</li>
          <li>Implement rule executor library with strategy pattern.</li>
          <li>Allocation preview table with variance column.</li>
          <li>Unit tests (jest) for each strategy; branch â‰¥â€¯85â€¯%.</li>
        </ul>
      </li>
      <li><strong>MetricsÂ Entry UI:</strong>
        <ul class="subtask-list">
          <li>Inlineâ€‘edit grid (AGâ€‘Grid) with validation &amp; autosave.</li>
          <li>History sideâ€‘panel (diff view) â€“ colour add/del.</li>
        </ul>
      </li>
      <li><strong>Docs:</strong> add â€œAllocationÂ Rulesâ€ page to runbookÂ Â§6.</li>
    </ul>
  </td>
</tr>

<tr>
  <td>13â€“14</td>
  <td>SepÂ 1â€¯â€“â€¯Sepâ€¯14,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>AdminÂ Console:</strong>
        <ul class="subtask-list">
          <li>CRUD pages for Industries, MasterÂ Clients, Ops (collapsible rows).</li>
          <li>Bulkâ€‘import ops via CSV template.</li>
          <li>AzureÂ AD group picker (GraphÂ API) for role assignment.</li>
        </ul>
      </li>
      <li><strong>Role &amp;Â Access:</strong>
        <ul class="subtask-list">
          <li>Add <code>withRoleGuard()</code> HOC; lazyâ€‘load protected routes.</li>
          <li>Graph deltaâ€‘sync job (Function timer) â†’ refresh group memberships nightly.</li>
          <li>Emailâ€‘invite template in SendGrid with deepâ€‘link to onboarding wizard.</li>
        </ul>
      </li>
      <li><strong>Audit surfacing:</strong> simple admin UI table for log review.</li>
    </ul>
  </td>
</tr>

<tr>
  <td>15â€“16</td>
  <td>SepÂ 15â€¯â€“â€¯Sepâ€¯28,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>BenchmarkingÂ Layer:</strong>
        <ul class="subtask-list">
          <li>Create Synapse pipeline â€“ copy <code>OpGLFact</code> nightly to DW.</li>
          <li>DAX measures: GrossÂ Marginâ€¯%, OpexÂ perÂ Mile, EBITDA margin.</li>
          <li>Rowâ€‘level security role filters by <code>OperationID</code>.</li>
        </ul>
      </li>
      <li><strong>Reports UI &amp; Export:</strong>
        <ul class="subtask-list">
          <li>Embed PowerÂ BI dashboard w/ token auth.</li>
          <li>Custom React chart fallback (Recharts) for viewers w/o BI license.</li>
          <li>Generate PDF via puppeteer â€“ branded header/footer.</li>
          <li>Excel export with <code>exceljs</code>; number formatting &amp; formulas.</li>
        </ul>
      </li>
      <li><strong>KPIÂ Dictionary page</strong> in Docs â†’ autoâ€‘publish to GitHubÂ Pages.</li>
    </ul>
  </td>
</tr>
<tr>
  <td>17â€“18</td>
  <td>SepÂ 29â€¯â€“â€¯Octâ€¯12,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>CI/CD Hardening:</strong>
        <ul class="subtask-list">
          <li>Matrix test (NodeÂ 18Â &amp;Â 20) + WebÂ Vitals budget in pipeline.</li>
          <li>Blue/Green slot swap for Functions; 5â€‘min bakedâ€‘in smoke tests.</li>
          <li>Static code analysis via SonarCloud; qualityâ€‘gate â‰¥â€¯B.</li>
          <li>OpenAPI contract tests with Dredd.</li>
        </ul>
      </li>
      <li><strong>Systemâ€‘wide Integration Tests:</strong>
        <ul class="subtask-list">
          <li>Dockerised MSSQL + Azurite in GitHubÂ Actions.</li>
          <li>Run Cypress in headless Chrome + Edge.</li>
          <li>Publish coverage &amp; lint reports as PR annotations.</li>
        </ul>
      </li>
      <li><strong>Disasterâ€‘Recovery Script:</strong> oneâ€‘click restore from geoâ€‘replica to test slot.</li>
    </ul>
  </td>
</tr>

<tr>
  <td>19â€“21</td>
  <td>OctÂ 13â€¯â€“â€¯Novâ€¯9,â€¯2025</td>
  <td>
    <ul class="task-list">
      <li><strong>LoadÂ &amp;Â ChaosÂ Testing:</strong>
        <ul class="subtask-list">
          <li>JMeterÂ â€“ 1â€¯million GL lines (5â€¯parallel uploads) &lt;â€¯10â€¯min ingest.</li>
          <li>Gremlin: kill Function instance; verify Durable resume.</li>
          <li>SQL DTU spike throttle test; autoâ€‘scale to Hyperscale tier.</li>
        </ul>
      </li>
      <li><strong>UAT &amp; Goâ€‘Live Prep:</strong>
        <ul class="subtask-list">
          <li>Stakeholder walkthrough; gather signâ€‘offs for Freight, Retail clients.</li>
          <li>Update onboarding docs + Loom videos.</li>
          <li>Freeze nonâ€‘critical PRs (codeâ€‘freezeÂ â€“ Octâ€¯31).</li>
        </ul>
      </li>
      <li><strong>Operational Readiness:</strong>
        <ul class="subtask-list">
          <li>24Ã—7 alert rota, runbook links in PagerDuty.</li>
          <li>Knowledgeâ€‘transfer sessions with Support team.</li>
        </ul>
      </li>
    </ul>
  </td>
</tr>
<tr>
<td>22â€“23</td>
<td>Nov 10 â€“ Nov 23, 2025</td>
<td>
<ul class="task-list">
<li><strong>Final Adjustments &amp; Production Deployment:</strong>
<ul class="subtask-list">
<li>Merge changes from <code>main</code> to <code>release</code> branch; resolve conflicts.</li>
<li>Trigger GitHub Actions release workflow; await manual approval for production.</li>
<li>Smoke test production deployment:
                      <ul class="subtask-list">
<li>Perform sanity checks: login, upload small GL, generate mapping suggestions, finalize, view benchmarks.</li>
<li>Check Application Insights for any errors or performance anomalies.</li>
</ul>
</li>
<li>Set up Alert Rules in Azure Monitor:
                      <ul class="subtask-list">
<li>Function failures (status code â‰¥ 500): email + Teams alert.</li>
<li>High SQL DTU usage (&gt; 70%): notify DB admin.</li>
<li>Unusual spikes in OpenAI API errors: notify dev team.</li>
</ul>
</li>
<li>Conduct Production Readiness Review with stakeholders (security, compliance, performance).</li>
</ul>
</li>
<li><strong>Project Retrospective &amp; Documentation Finalization:</strong>
<ul class="subtask-list">
<li>Hold retrospective meeting with dev team:
                      <ul class="subtask-list">
<li>What went well, what could improve, lessons learned.</li>
<li>Create action items for post-MVP enhancements (e.g., multi-currency support, additional AI logic).</li>
</ul>
</li>
<li>Update this Run Book with final production details:
                      <ul class="subtask-list">
<li>Production connection strings, resource URIs, DNS records.</li>
<li>Final user documentation and training guides.</li>
<li>Maintenance plan: patch schedule, backup/restoration procedures.</li>
</ul>
</li>
<li>Archive code branches, tag release in Git with version <code>v1.0.0</code>.</li>
</ul>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<h2 id="codex">13Â Â·Â CodexÂ WorkflowÂ &amp;Â RepoÂ Docs</h2>
<h3>13.1Â HouseÂ Rules</h3>
<ul>
<li><strong>Authoritative source:</strong> treat this runbook as ground truth.Â If a user request conflicts, ask for clarification before coding.</li>
<li><strong>Additive changes:</strong> default to additive PRs that keep existing functionality intact unless the ticket explicitly requests deletion/refactor.</li>
<li><strong>Migration safety:</strong> all DB migrations must be idempotent and backwardâ€‘compatible until the schema version is bumped in <code>db/meta</code>.</li>
<li><strong>Testing gate:</strong> PRs must pass <code>npm test</code> (frontâ€‘end) and <code>pytest</code> (AzureÂ Functions) with â‰¥Â 80â€¯% coverage.Â CI fails otherwise.</li>
<li><strong>PR hygiene:</strong> one logical feature per PR, conventionalâ€‘commit style titles (<code>feat:</code>, <code>fix:</code>, <code>docs:</code>, <code>refactor:</code> â€¦).</li>
</ul>
<h3>13.2Â AGENTS.mdÂ Autoâ€‘RefreshÂ Prompt</h3>
<p>Copy &amp; paste the block below into a Codex chat.Â It will scan the repo and either create or update an <code>AGENTS.md</code> in every topâ€‘level folder.</p>
<pre><code>You are Codex acting as a repository doc bot.
====================  TASK ====================
For every topâ€‘level folder under /src and /azure:
1.  Open the existing AGENTS.md or create a new one.
2.  Populate it using the template below.
3.  Commit all changes in a single PR titled **docs: refresh agents overview**.
4.  Do NOT modify application logic or nonâ€‘documentation files.

==================  TEMPLATE  ==================
# &lt;Folder Name&gt;

**Purpose**  
Oneâ€‘line description of what lives here.

## Key Exports
| Name | Type | Description |
|------|------|-------------|
| &lt;export1&gt; | function / component | What it does |
| â€¦ | â€¦ | â€¦ |

## Runbook Crossâ€‘References
Â§3 SystemÂ Architecture, Â§4 Ingestion, Â§8 UX (edit as relevant)

## TODOÂ (owner: @unassigned)
1. Meaningful docâ€‘only tasks or techâ€‘debt (max 5)
2. â€¦
================================================</code></pre>
<p><em>After Codex runs, each folder will have a quickâ€‘start summary that future agents (or humans) can read before editing code.</em></p>
<hr/>
<footer><p style="font-size:.8rem;color:#555">Â©Â 2025Â KSMÂ â€“Â MapLedgerÂ TeamÂ Â Â Last updated:Â 23Â JunÂ 2025</p></footer>
</div>
</body>
</html>